{% extends 'simulador/base.html' %}
{% load formato_br %}
{% block title %}Resumo da Simulação - Simulador{% endblock %}

{% block content_class %}resumo-page{% endblock %}

{% block content %}
<div class="container bg-light text-dark p-3 rounded shadow" style="margin-top: 5px;">

  <div class="border-bottom pb-2 mb-3">
    <h5 class="mb-0">Resumo da Simulação</h5>
  </div>
  
  <div class="row">
    <div class="col-md-6">
      <h6 class="border-bottom pb-1 mb-3">Configurações</h6>
      
      {% for pagina, dados in respostas_agrupadas.items %}
        <div class="card mb-3 card-collapsible">
          <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center collapse-header" data-bs-toggle="collapse" data-bs-target="#collapse-{{ forloop.counter }}" aria-expanded="false">
            {{ pagina }}
            <i class="fas fa-chevron-down collapse-icon"></i>
          </div>
          <div class="collapse" id="collapse-{{ forloop.counter }}">
            <div class="card-body">
              {% if pagina == "Portas" %}
                <h6 class="border-bottom pb-1 mb-2">Portas de Cabine</h6>
                {% for chave, valor in dados.items %}
                  {% if "Pavimento" not in chave %}
                    <p><strong>{{ chave }}:</strong> {{ valor }}</p>
                  {% endif %}
                {% endfor %}
                
                <h6 class="border-bottom pb-1 mt-3 mb-2">Portas de Pavimento</h6>
                {% for chave, valor in dados.items %}
                  {% if "Pavimento" in chave %}
                    <p><strong>{{ chave }}:</strong> {{ valor }}</p>
                  {% endif %}
                {% endfor %}
              {% else %}
                {% for chave, valor in dados.items %}
                  <p><strong>{{ chave }}:</strong> {{ valor }}</p>
                {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
      {% empty %}
        <div class="alert alert-warning">
          Nenhuma informação disponível. Por favor, complete todas as etapas da simulação.
        </div>
      {% endfor %}
    </div>
    
    <div class="col-md-6">
      <h6 class="border-bottom pb-1 mb-3">Cálculos</h6>
      
      <div class="card mb-3 card-collapsible">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center collapse-header" data-bs-toggle="collapse" data-bs-target="#collapse-ficha" aria-expanded="false">
          Ficha Técnica
          <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="collapse" id="collapse-ficha">
          <div class="card-body">
            <p><strong>Dimensões Cabine:</strong> {{ dimensionamento.cab.largura|formato_br }}m L x 
               {{ dimensionamento.cab.compr|formato_br }}m C x 
               {{ dimensionamento.cab.altura|formato_br }}m A</p>
            <p><strong>Capacidade e Tração Cabine:</strong> 
               {{ dimensionamento.cab.capacidade|formato_br }} kg, 
               {{ dimensionamento.cab.tracao|formato_br }} kg</p>
          </div>
        </div>
      </div>
      
      {% if user_level != 'vendedor' %}
      <div class="card mb-3 card-collapsible">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center collapse-header" data-bs-toggle="collapse" data-bs-target="#collapse-dimensionamento" aria-expanded="false">
          Cálculo Dimensionamento
          <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="collapse" id="collapse-dimensionamento">
          <div class="card-body dimensionamento-highlights">
            {{ explicacao|safe }}
          </div>
        </div>
      </div>
      
      <div class="card mb-3 card-collapsible">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center collapse-header" data-bs-toggle="collapse" data-bs-target="#collapse-componentes" aria-expanded="false">
          Componentes
          <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="collapse" id="collapse-componentes">
          <div class="card-body">
            {% for grupo_nome, subgrupos in grupos.items %}
              <h6 class="border-bottom pb-1 mb-2">{{ grupo_nome }}</h6>
              {% for subgrupo_nome, itens in subgrupos.items %}
                <p class="mb-1"><strong>{{ subgrupo_nome }}</strong></p>
                <ul class="mb-3">
                  {% for item in itens %}
                    <li>
                      <strong>{{ item.descricao }}</strong> ({{ item.codigo }}) - 
                      {{ item.quantidade|formato_br }} {{ item.unidade }},
                      Custo: R$ {{ item.custo_total|formato_br }}
                    </li>
                  {% endfor %}
                </ul>
              {% endfor %}
            {% endfor %}
            <div class="alert alert-success">
              <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Custo estimado:</h4>
                <h3 class="mb-0">R$ {{ custo_total|formato_br }}</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      
      <div class="alert alert-success">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Custo estimado:</h4>
          <h3 class="mb-0">R$ {{ custo_total|formato_br }}</h3>
        </div>
      </div>
      
      {% if user_level != 'vendedor' %}
      <div class="row mt-3">
        <div class="col-md-6">
          <form method="post" action="{% url 'simulador:gerar_pdf' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary w-100">Gerar PDF</button>
          </form>
        </div>
        <div class="col-md-6">
          <form method="post" action="{% url 'simulador:proposta_comercial' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success w-100">Gerar Proposta Comercial</button>
          </form>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  
  <div class="d-flex justify-content-between mt-3">
    <a href="{% url 'simulador:cabine' %}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-chevron-left"></i> Voltar
    </a>
    <form method="post" action="{% url 'simulador:reiniciar_simulacao' %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-warning btn-sm">
        <i class="fas fa-redo"></i> Iniciar Nova Simulação
      </button>
    </form>
  </div>
</div>

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Adiciona event listeners para todos os cabeçalhos colapsáveis
    const collapseHeaders = document.querySelectorAll('.collapse-header');
    
    collapseHeaders.forEach(header => {
      header.addEventListener('click', function() {
        const target = this.getAttribute('data-bs-target');
        const collapseElement = document.querySelector(target);
        const icon = this.querySelector('.collapse-icon');
        
        // Toggle da classe 'show' no elemento colapsável
        collapseElement.classList.toggle('show');
        
        // Rotaciona o ícone
        if (collapseElement.classList.contains('show')) {
          icon.classList.remove('fa-chevron-down');
          icon.classList.add('fa-chevron-up');
          this.setAttribute('aria-expanded', 'true');
        } else {
          icon.classList.remove('fa-chevron-up');
          icon.classList.add('fa-chevron-down');
          this.setAttribute('aria-expanded', 'false');
        }
      });
    });
    
    // Adiciona formatação aos valores numéricos no explicação de dimensionamento
    const dimensionamentoDiv = document.querySelector('.dimensionamento-highlights');
    if (dimensionamentoDiv) {
      let content = dimensionamentoDiv.innerHTML;
      
      // Substituir números por números formatados com destaque no padrão brasileiro
      content = content.replace(/(\d+\.\d+|\d+)/g, function(match) {
        // Verifica se é um número com casa decimal
        if (match.includes('.')) {
          const num = parseFloat(match);
          // Formatar para padrão brasileiro (com vírgula como decimal e ponto como separador de milhar)
          const numFormatado = num.toFixed(2).replace('.', ',');
          return '<span class="highlight-value">' + numFormatado + '</span>';
        }
        // Para números inteiros, apenas adicionar o destaque
        return '<span class="highlight-value">' + match + '</span>';
      });
      
      dimensionamentoDiv.innerHTML = content;
    }
  });
</script>
{% endblock %}
{% endblock %}